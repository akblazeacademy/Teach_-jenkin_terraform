pipeline {
    agent any

    parameters {
        choice(
            name: 'ENV',
            choices: ['dev', 'qa1', 'prod'],
            description: 'Select the environment'
        )
        string(name: 'RG_NAME', defaultValue: 'myRG', description: 'Resource Group Name')
        string(name: 'VNET_NAME', defaultValue: 'myVNet', description: 'VNET Name')
        string(name: 'SUBNET_NAME', defaultValue: 'mySubnet', description: 'Subnet Name')

        choice(
            name: 'ACTION',
            choices: ['init-plan', 'init-plan-apply'],
            description: 'Choose Terraform Action'
        )

        string(name: 'ARM_SUBSCRIPTION_ID', defaultValue: '', description: 'Azure Subscription ID')
        string(name: 'ARM_CLIENT_ID', defaultValue: '', description: 'Azure SP App ID')
        password(name: 'ARM_CLIENT_SECRET', defaultValue: '', description: 'Azure SP Client Secret')
        string(name: 'ARM_TENANT_ID', defaultValue: '', description: 'Azure Tenant ID')
    }

    environment {
        STORAGE_ACCOUNT = "blazeungabungawarrison"
        LOCATION        = "eastus"

        // IMPORTANT FIX
        MODULE_PATH     = "${WORKSPACE}/terraform"
    }

    stages {

        stage("Show Inputs") {
            steps {
                echo "Environment: ${params.ENV}"
                echo "RG Name: ${params.RG_NAME}"
                echo "VNET Name: ${params.VNET_NAME}"
                echo "Subnet Name: ${params.SUBNET_NAME}"
                echo "Action: ${params.ACTION}"

                echo "Using Subscription: ${params.ARM_SUBSCRIPTION_ID}"
                echo "Using App ID: ${params.ARM_CLIENT_ID}"
                echo "Using Tenant ID: ${params.ARM_TENANT_ID}"
            }
        }

        stage("Export Azure Credentials") {
            steps {
                sh """
                export ARM_SUBSCRIPTION_ID='${params.ARM_SUBSCRIPTION_ID}'
                export ARM_CLIENT_ID='${params.ARM_CLIENT_ID}'
                export ARM_CLIENT_SECRET='${params.ARM_CLIENT_SECRET}'
                export ARM_TENANT_ID='${params.ARM_TENANT_ID}'
                """
            }
        }

        stage("Terraform Init") {
            steps {
                dir("${MODULE_PATH}") {

                    sh """
                    cat > backend.tf <<EOF
                    terraform {
                      backend "azurerm" {
                        resource_group_name  = "STATE-RG"
                        storage_account_name = "${STORAGE_ACCOUNT}"
                        container_name       = "${params.ENV}"
                        key                  = "${params.ENV}.tfstate"
                      }
                    }
                    EOF
                    """

                    sh "terraform init -upgrade"
                }
            }
        }

        stage("Terraform Plan") {
            steps {
                dir("${MODULE_PATH}") {
                    sh """
                        terraform plan \
                          -var rg_name=${params.RG_NAME} \
                          -var vnet_name=${params.VNET_NAME} \
                          -var subnet_name=${params.SUBNET_NAME} \
                          -var environment=${params.ENV}
                    """
                }
            }
        }

        stage("Terraform Apply (Optional)") {
            when {
                expression { params.ACTION == "init-plan-apply" }
            }
            steps {
                dir("${MODULE_PATH}") {
                    sh """
                        terraform apply -auto-approve \
                          -var rg_name=${params.RG_NAME} \
                          -var vnet_name=${params.VNET_NAME} \
                          -var subnet_name=${params.SUBNET_NAME} \
                          -var environment=${params.ENV}
                    """
                }
            }
        }
    }
}
